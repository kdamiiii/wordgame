<!DOCTYPE html>
<html>
    <head>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
        <script src="../js/common.js"></script>
        <script src="../js/components.js"></script>
        <link rel="stylesheet" href="../css/global.css">

        <script type="module">
            import { initializeApp} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js"
            import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js"

            const firebaseConfig = {
                apiKey: "AIzaSyDKMHzLM_uhZyaNPm6k3TORTvQSm7zvvKs",
                authDomain: "word-game-b887b.firebaseapp.com",
                databaseURL: "https://word-game-b887b-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "word-game-b887b",
                storageBucket: "word-game-b887b.appspot.com",
                messagingSenderId: "177684283581",
                appId: "1:177684283581:web:ecb25c71aec84aad5fb7d4"
            };

            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);

            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);

            const hash = urlParams.get('lobbyhash');
            const playerName = urlParams.get('name');

            const redTeamList = document.getElementById('red-list');
            const blueTeamList = document.getElementById('blue-list');
            const noTeamList = document.getElementById('noteam-list');

            const playerRef = ref(db, 'lobbies/'+hash+'/players');
            const gameStartRef = ref(db, 'lobbies/'+hash+'/gameStatus/isGameActive');

            let playerData = null;

            onValue(gameStartRef, (gameSnapshot) => {
                const isGameActive = gameSnapshot.val();
                if(isGameActive){
                    const baseUrl = window.location.href.replace('game-lobby.html','game-start.html');

                    window.location.href = baseUrl;
                }
            });

            onValue(playerRef, (snapshot) => {
                playerData = snapshot.val();

                redTeamList.innerHTML = '';
                blueTeamList.innerHTML = '';
                noTeamList.innerHTML = '';

                for(let x in playerData){
                    const listItem = document.createElement('h4');
                    listItem.innerText = x;

                    if(playerData[x].includes("red")){
                        if(playerData[x].includes('spymaster')){
                            const spymasterName = document.getElementById('red-spymaster-name');
                            spymasterName.innerHTML = '';
                            const spymaster = document.createElement('h1');
                            spymaster.textContent = x;
                            spymasterName.appendChild(spymaster);
                        }
                        else{
                            redTeamList.appendChild(listItem)
                        }
                    }

                    else if(playerData[x].includes("blue")){
                        if(playerData[x].includes('spymaster')){
                            const spymasterName = document.getElementById('blue-spymaster-name');
                            spymasterName.innerHTML = '';
                            const spymaster = document.createElement('h1');
                            spymaster.textContent = x;
                            spymasterName.appendChild(spymaster);
                        }
                        else{
                            blueTeamList.appendChild(listItem)
                        }
                    }
                    else {
                        noTeamList.appendChild(listItem)
                    }
                }
                

                document.getElementById('join-red-team').onclick = function(){
                    if(!playerData[playerName].includes('red') && !playerData[playerName].includes('spymaster')){
                        const updates = {};
                        update(ref(db),{[`lobbies/${hash}/players/${playerName}`] : 'red'})
                    }
                }

                document.getElementById('join-blue-team').onclick = function(){
                    if(!playerData[playerName].includes('blue') && !playerData[playerName].includes('spymaster')){
                        const updates = {};
                        update(ref(db),{[`lobbies/${hash}/players/${playerName}`] : 'blue'})
                    }
                }

                if(!containsStringInValues(playerData, 'blue-spymaster')){
                    document.getElementById('join-blue-spymaster').onclick = function(){
                        update(ref(db), {[`lobbies/${hash}/players/${playerName}`]:'blue-spymaster'})
                    }
                }

                if(!containsStringInValues(playerData, 'red-spymaster')){
                    document.getElementById('join-red-spymaster').onclick = function(){
                        update(ref(db), {[`lobbies/${hash}/players/${playerName}`]:'red-spymaster'})
                    }
                }

                document.getElementById('start-lobby').onclick = function(){
                    console.log(checkSpymasters(playerData));
                    if(checkSpymasters(playerData)){
                        const updates = {
                            [`lobbies/${hash}/gameStatus/isGameActive`]:true,
                            [`lobbies/${hash}/gameStatus/turn`]: getRandomColor(playerData),
                        }
                        update(ref(db), updates)
                    }
                    else{
                        alert('Spymasters have not been assigned');
                    }
                };
            });
        </script>

    </head>
    <body>
        <div id="gamedisplay">
            <div id="red">
                <div class="team-header">
                    <h1>Red Team</h1>
                    <button id="join-red-team" type="button"  class="btn btn-light">Join Team</button>
                </div>
                <div id="red-list" class="player-lists">
                </div>
                
                <div id="red-spymaster" class="spymaster">
                    <h4>Spymaster:</h4>
                    <div id="red-spymaster-name">
                        <button id="join-red-spymaster" type="button"  class="btn btn-light">Join as Spymaster</button>
                    </div>
                </div>
            </div>

            <div id="center" class="center">
                <h1>Players</h1>
                <div id="noteam-list">
                </div>
                
            </div>

            <div id="blue">
                <div class="team-header">
                    <h1>Blue Team</h1>
                    <button id="join-blue-team" type="button"  class="btn btn-light">Join Team</button>
                </div>
                <div id="blue-list">
                </div>
                <div id="blue-spymaster" class="spymaster">
                    <h4>Spymaster:</h4>
                    <div id="blue-spymaster-name">
                        <button id="join-blue-spymaster" type="button"  class="btn btn-light">Join as Spymaster</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="button-container">
            <button id="start-lobby" type="button" class="btn btn-primary">Start Game</button>
        </div>
        <script>
            
        </script>
    </body>
</html>