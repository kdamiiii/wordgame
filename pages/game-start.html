<!DOCTYPE html>
<html>
    <head>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
        <script src="../js/common.js"></script>
        <script src="../js/components.js"></script>
        
        <link rel="stylesheet" href="../css/global.css">
        <script type="module">
            import { initializeApp} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js"
            import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js"

            const firebaseConfig = {
                apiKey: "AIzaSyDKMHzLM_uhZyaNPm6k3TORTvQSm7zvvKs",
                authDomain: "word-game-b887b.firebaseapp.com",
                databaseURL: "https://word-game-b887b-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "word-game-b887b",   
                storageBucket: "word-game-b887b.appspot.com",
                messagingSenderId: "177684283581",
                appId: "1:177684283581:web:ecb25c71aec84aad5fb7d4"
            };

            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);

            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);

            const hash = localStorage.getItem('lobbyHash');
            const playerName = localStorage.getItem('playerName');
            let playerRole = null;

            const playerRef = ref(db, 'lobbies/'+hash+'/players');
            const gameStatusRef = ref(db, 'lobbies/'+hash+'/gameStatus');
            
            const announcement = document.getElementById('announcement');

            onValue(gameStatusRef, ((gameSnapShot)=>{
                const gameData = gameSnapShot.val();
                if(!gameData.isGameActive){
                    const baseUrl = window.location.href.replace('game-start.html','game-lobby.html');
                    const newUrl = `${baseUrl}`;
                    window.location.href = newUrl;
                }
                document.getElementById('redCards').innerHTML = gameData.redCards;
                document.getElementById('blueCards').innerHTML = gameData.blueCards;
                announcement.innerHTML = '';
                onValue(playerRef, (playerSnapshot)=>{
                    const playerData = playerSnapshot.val();
                    document.getElementById('bluePlayers').innerHTML = '';
                    document.getElementById('redPlayers').innerHTML = '';

                    for(let i in playerData){
                        const playerBadge = document.createElement('span');
                        playerBadge.innerText = i
                        if(playerData[i] == 'blue'){
                            playerBadge.className = 'badge bg-primary';
                            document.getElementById('bluePlayers').appendChild(playerBadge);
                        }
                        else if (playerData[i] == 'red'){
                            playerBadge.className = 'badge bg-danger';
                            document.getElementById('redPlayers').appendChild(playerBadge);
                        }
                        else if (playerData[i] == 'blue-spymaster'){
                            document.getElementById('bluespymaster').innerText = i;
                        }
                        else if (playerData[i] == 'red-spymaster'){
                            document.getElementById('redspymaster').innerText = i;
                        }
                    }
                    const playerInfo = document.getElementById('playerName');
                    playerInfo.innerHTML = 'You are: ';
                    const playerInfoBadge = document.createElement('span');
                    playerInfoBadge.className = `badge bg-${playerData[playerName].includes('blue') ? 'primary' : 'danger'}`
                    playerInfoBadge.innerText = playerName;
                    playerInfo.appendChild(playerInfoBadge);

                    const cardsContainer = document.getElementById('center');
                    cardsContainer.innerHTML = '';
                    cardsContainer.className = 'card-container'
                    const words = gameData.words;
                    const visible = playerData[playerName].includes('spymaster');
                    playerRole = playerData[playerName];

                    const turn = gameData.turn;
                    document.getElementById('player-options').innerHTML = '';

                    const logs = document.getElementById('logs');
                    logs.innerHTML = '';

                    for(let xLog in gameData.logs){
                        const newLog = document.createElement('div');
                        const nameSpan = document.createElement('b');
                        nameSpan.style.fontWeight = 'strong';
                        nameSpan.innerText = gameData.logs[xLog].player;

                        newLog.appendChild(nameSpan);
                        if(gameData.logs[xLog].type == 'clue'){
                            const wordSpan = document.createElement('b');
                            wordSpan.style.fontWeight = 'strong';
                            wordSpan.style.color = colorCheck(gameData.logs[xLog].team).bgColor; 
                            wordSpan.innerText = `${gameData.logs[xLog].word}(${gameData.logs[xLog].wordCount})`;
                            const spanElement = document.createElement('span');
                            spanElement.textContent = ' gave a clue: ';
                            newLog.appendChild(spanElement);
                            newLog.appendChild(wordSpan);
                        }
                        else{
                            const wordSpan = document.createElement('b');
                            wordSpan.style.fontWeight = 'strong';
                            wordSpan.style.color = colorCheck(gameData.logs[xLog].wordColor).bgColor; 
                            wordSpan.innerText = gameData.logs[xLog].word;
                            const spanElement = document.createElement('span');
                            spanElement.textContent = ' selected: ';
                            newLog.appendChild(spanElement);
                            newLog.appendChild(wordSpan);
                        }
                        
                            newLog.style.color = colorCheck(gameData.logs[xLog].team).bgColor;

                        logs.appendChild(newLog);
                    }

                    if(gameData.blueCards < 1){
                        document.body.style.backgroundColor = '#213268';
                        const winner = document.createElement('div');
                        winner.className = 'winner';
                        winner.innerText = 'BLUE TEAM WINS!'
                        announcement.appendChild(winner);
                        for(let i in words){
                            const newDiv = createCard(words[i].name, words[i].color, true, words[i].viewed);
                            cardsContainer.appendChild(newDiv);
                        }
                    }
                    else if(gameData.redCards < 1){
                        document.body.style.backgroundColor = '#662727';
                        const winner = document.createElement('div');
                        winner.className = 'winner';
                        winner.innerText = 'BLUE TEAM WINS!'
                        announcement.appendChild(winner)
                        for(let i in words){
                            const newDiv = createCard(words[i].name, words[i].color, true, words[i].viewed);
                            cardsContainer.appendChild(newDiv);
                        }
                    }

                    /*
                    
                    
                    
                    BLUE TURN BLUE TURN BLUE TURN
                    
                    
                    
                    */

                    else if(turn == 'blue'){
                        document.body.style.backgroundColor = '#213268';
                        if(gameData.clue){
                            announcement.innerHTML = `BLUE TEAM is Guessing! CLUE: ${gameData.clue} [${gameData.clueCount}]`;
                            if(playerRole == 'blue'){
                                for(let i in words){
                                    const newDiv = createCard(words[i].name, words[i].color, visible, words[i].viewed);
                                    
                                    if(!words[i].viewed){
                                        const button = document.createElement('button');
                                        button.className = 'btn btn-success';
                                        button.innerText = "Select";
                                        
                                        button.onclick = function(){
                                            if(words[i].color == 'blue'){
                                                let clueCount = gameData.clueCount - 1;
                                                const turn = clueCount < 1 ? 'red' : 'blue';
                                                const blueScore = gameData.blueCards - 1;

                                                let clue = clueCount < 1? null : gameData.clue;

                                                const action = {
                                                    type:'select',
                                                    player:playerName,
                                                    word: words[i].name,
                                                    wordColor: words[i].color,
                                                    team: 'blue'
                                                }

                                                const updates = {
                                                    [`lobbies/${hash}/gameStatus/clue/`]:clue,
                                                    [`lobbies/${hash}/gameStatus/clueCount/`]:clueCount,
                                                    [`lobbies/${hash}/gameStatus/turn/`]:turn,
                                                    [`lobbies/${hash}/gameStatus/blueCards/`]:blueScore,
                                                    [`lobbies/${hash}/gameStatus/words`]: setWordViewersToNull(words, words[i].name),
                                                    [`lobbies/${hash}/gameStatus/logs`]: [...gameData.logs, action] 
                                                }

                                                update(ref(db), updates);
                                            }
                                            else if(words[i].color == 'red'){
                                                const action = {
                                                    type:'select',
                                                    player:playerName,
                                                    word: words[i].name,
                                                    wordColor: words[i].color,
                                                    team: 'blue'
                                                }

                                                const updates = {
                                                    [`lobbies/${hash}/gameStatus/clue/`]:null,
                                                    [`lobbies/${hash}/gameStatus/clueCount/`]:null,
                                                    [`lobbies/${hash}/gameStatus/turn/`]:'red',
                                                    [`lobbies/${hash}/gameStatus/redCards/`]:gameData.redCards - 1,
                                                    [`lobbies/${hash}/gameStatus/words`]: setWordViewersToNull(words, words[i].name),
                                                    [`lobbies/${hash}/gameStatus/logs`]: [...gameData.logs, action] 
                                                }

                                                update(ref(db), updates);
                                            }
                                            else if(words[i].color == 'neutral'){
                                                const action = {
                                                    type:'select',
                                                    player:playerName,
                                                    word: words[i].name,
                                                    wordColor: words[i].color,
                                                    team: 'blue'
                                                }

                                                const updates = {
                                                    [`lobbies/${hash}/gameStatus/clue/`]:null,
                                                    [`lobbies/${hash}/gameStatus/clueCount/`]:null,
                                                    [`lobbies/${hash}/gameStatus/turn/`]:'red',
                                                    [`lobbies/${hash}/gameStatus/words`]: setWordViewersToNull(words, words[i].name),
                                                    [`lobbies/${hash}/gameStatus/logs`]: [...gameData.logs, action] 
                                                }

                                                update(ref(db), updates);
                                            }
                                            else if(words[i].color == 'black'){
                                                const action = {
                                                    type:'select',
                                                    player:playerName,
                                                    word: words[i].name,
                                                    wordColor: words[i].color,
                                                    team: 'blue'
                                                }

                                                const updates = {
                                                    [`lobbies/${hash}/gameStatus/clue/`]:null,
                                                    [`lobbies/${hash}/gameStatus/clueCount/`]:null,
                                                    [`lobbies/${hash}/gameStatus/turn/`]:'red',
                                                    [`lobbies/${hash}/gameStatus/blueCards/`]:0,
                                                    [`lobbies/${hash}/gameStatus/words`]: setWordViewersToNull(words, words[i].name),
                                                    [`lobbies/${hash}/gameStatus/logs`]: [...gameData.logs, action] 
                                                }

                                                update(ref(db), updates);
                                            }
                                        }
                                        newDiv.appendChild(button);
                                    }

                                    newDiv.onclick = function(){
                                        if(words[i].viewers && words[i]?.viewers.includes(playerName)){
                                            let updatedViewers = words[i].viewers.filter(item => item !== playerName);
                                            const updates = {
                                                [`lobbies/${hash}/gameStatus/words/${i}/viewers`] : updatedViewers
                                            }
                                            update(ref(db), updates);
                                        }
                                        else if(words[i].viewers == null){

                                            const updates = {
                                                [`lobbies/${hash}/gameStatus/words/${i}/viewers`] : [playerName]
                                            }
                                            update(ref(db), updates);
                                        }
                                        else{
                                            const updates = {
                                                [`lobbies/${hash}/gameStatus/words/${i}/viewers`] : [...words[i].viewers, playerName]
                                            }
                                            update(ref(db), updates);
                                        }
                                        
                                    }

                                    if(!words[i].viewed){
                                        newDiv.appendChild(createUserHints(words[i].viewers, playerData));
                                    }

                                    cardsContainer.appendChild(newDiv);
                                }
                            }
                            else{
                                for(let i in words){
                                    const newDiv = createCard(words[i].name, words[i].color, visible, words[i].viewed);
                                    newDiv.appendChild(createUserHints(words[i].viewers, playerData));
                                    cardsContainer.appendChild(newDiv);
                                }
                            }
                        }
                        else{
                            if(playerRole == 'blue-spymaster'){
                                for(let i in words){
                                    cardsContainer.appendChild(createCard(words[i].name, words[i].color, visible, words[i].viewed))
                                }

                                const container = document.createElement('div');
                                container.className = 'input-container';
                                // container.style.width = '40%';

                                const input = document.createElement('input');
                                input.type = 'text';
                                input.className = 'form-control-lg';
                                input.id = 'clue-input';
                                input.maxLength = 20;

                                const numberInput = document.createElement('input');
                                numberInput.id = 'number-input-dog'
                                numberInput.type = 'number';
                                numberInput.className = 'form-control-lg number-input';
                                numberInput.max=10;
                                numberInput.min=1;

                                // Append the outer div to the body (or another container element)
                                const labelll = document.createElement('h4');
                                labelll.innerText = 'CLUE:'
                                labelll.style.color = 'white'
                                container.appendChild(labelll);
                                container.appendChild(input);

                                const numberContainer = document.createElement('div');
                                numberContainer.className = 'input-container';
                                numberContainer.style.width = '10em !important';

                                numberContainer.appendChild(numberInput);

                                const button = document.createElement('button');
                                button.type = 'button';
                                button.className = 'btn btn-success';
                                button.innerText = 'Confirm'
                                button.style.height = '100%'

                                button.onclick = function(){
                                    const num = document.getElementById('number-input-dog').value;
                                    const textinput = document.getElementById('clue-input').value;
                                    if(num && textinput){
                                        const action = {
                                            type:'clue',
                                            player:playerName,
                                            word: textinput,
                                            team: 'blue',
                                            wordCount: num
                                        }
                                        const updates = {
                                            [`lobbies/${hash}/gameStatus/clue`]:textinput,
                                            [`lobbies/${hash}/gameStatus/clueCount`]: num,
                                            [`lobbies/${hash}/gameStatus/logs`]: 
                                            gameData.logs ? [...gameData.logs, action] : [action] 
                                        }
                                        update(ref(db), updates);
                                    }
                                    else{
                                        alert('Missing inputs');
                                    }
                                }

                                document.getElementById('player-options').appendChild(container);
                                document.getElementById('player-options').appendChild(numberContainer);
                                document.getElementById('player-options').appendChild(button);
                            }
                            else{
                                announcement.innerHTML = 'BLUE SPYMASTER is giving a clue'
                                for(let i in words){
                                    const newDiv = createCard(words[i].name, words[i].color, visible, words[i].viewed);
                                    // newDiv.appendChild(createUserHints(words[i].viewers), playerData);
                                    cardsContainer.appendChild(newDiv);
                                }
                            }
                        }
                    }

                    /*
                    
                    
                    
                    RED TURN RED TURN RED TURN
                    
                    
                    
                    */

                    else{
                        document.body.style.backgroundColor = '#662727';
                        if(gameData.clue){
                            //Red players turn
                            announcement.innerHTML = `RED TEAM is Guessing! CLUE: ${gameData.clue} [${gameData.clueCount}]`;
                            if(playerRole == 'red'){
                                
                                for(let i in words){
                                    const newDiv = createCard(words[i].name, words[i].color, visible, words[i].viewed);
                                    
                                    if(!words[i].viewed){
                                        const button = document.createElement('button');
                                        button.className = 'btn btn-success';
                                        button.innerText = "Select";
                                        
                                        button.onclick = function(){
                                            if(words[i].color == 'red'){
                                                let clueCount = gameData.clueCount - 1;
                                                const turn = clueCount < 1 ? 'blue' : 'red';
                                                const redScore = gameData.redCards - 1;

                                                let clue = clueCount < 1? null : gameData.clue;

                                                const action = {
                                                    type:'select',
                                                    player:playerName,
                                                    word: words[i].name,
                                                    wordColor: words[i].color,
                                                    team: 'red'
                                                }

                                                const updates = {
                                                    [`lobbies/${hash}/gameStatus/clue/`]:clue,
                                                    [`lobbies/${hash}/gameStatus/clueCount/`]:clueCount,
                                                    [`lobbies/${hash}/gameStatus/turn/`]:turn,
                                                    [`lobbies/${hash}/gameStatus/redCards/`]:redScore,
                                                    [`lobbies/${hash}/gameStatus/words`]: setWordViewersToNull(words, words[i].name),
                                                    [`lobbies/${hash}/gameStatus/logs`]: [...gameData.logs, action] 
                                                }

                                                update(ref(db), updates);
                                            }
                                            else if(words[i].color == 'blue'){
                                                const action = {
                                                    type:'select',
                                                    player:playerName,
                                                    word: words[i].name,
                                                    wordColor: words[i].color,
                                                    team: 'red'
                                                }

                                                const updates = {
                                                    [`lobbies/${hash}/gameStatus/clue/`]:null,
                                                    [`lobbies/${hash}/gameStatus/clueCount/`]:null,
                                                    [`lobbies/${hash}/gameStatus/turn/`]:'blue',
                                                    [`lobbies/${hash}/gameStatus/blueCards/`]:gameData.blueCards - 1,
                                                    [`lobbies/${hash}/gameStatus/words`]: setWordViewersToNull(words, words[i].name),
                                                    [`lobbies/${hash}/gameStatus/logs`]: [...gameData.logs, action] 
                                                }

                                                update(ref(db), updates);
                                            }
                                            else if(words[i].color == 'neutral'){
                                                const action = {
                                                    type:'select',
                                                    player:playerName,
                                                    word: words[i].name,
                                                    wordColor: words[i].color,
                                                    team: 'red'
                                                }

                                                const updates = {
                                                    [`lobbies/${hash}/gameStatus/clue/`]:null,
                                                    [`lobbies/${hash}/gameStatus/clueCount/`]:null,
                                                    [`lobbies/${hash}/gameStatus/turn/`]:'blue',
                                                    [`lobbies/${hash}/gameStatus/words`]: setWordViewersToNull(words, words[i].name),
                                                    [`lobbies/${hash}/gameStatus/logs`]: [...gameData.logs, action] 
                                                }

                                                update(ref(db), updates);
                                            }
                                            else if(words[i].color == 'black'){
                                                const action = {
                                                    type:'select',
                                                    player:playerName,
                                                    word: words[i].name,
                                                    wordColor: words[i].color,
                                                    team: 'red'
                                                }

                                                const updates = {
                                                    [`lobbies/${hash}/gameStatus/clue/`]:null,
                                                    [`lobbies/${hash}/gameStatus/clueCount/`]:null,
                                                    [`lobbies/${hash}/gameStatus/turn/`]:'blue',
                                                    [`lobbies/${hash}/gameStatus/blueCards/`]:0,
                                                    [`lobbies/${hash}/gameStatus/words`]: setWordViewersToNull(words, words[i].name),
                                                    [`lobbies/${hash}/gameStatus/logs`]: [...gameData.logs, action] 
                                                }

                                                update(ref(db), updates);
                                            }
                                        }
                                        newDiv.appendChild(button);
                                    }

                                    newDiv.onclick = function(){
                                        if(words[i].viewers && words[i]?.viewers.includes(playerName)){
                                            let updatedViewers = words[i].viewers.filter(item => item !== playerName);
                                            const updates = {
                                                [`lobbies/${hash}/gameStatus/words/${i}/viewers`] : updatedViewers
                                            }
                                            update(ref(db), updates);
                                        }
                                        else if(words[i].viewers == null){

                                            const updates = {
                                                [`lobbies/${hash}/gameStatus/words/${i}/viewers`] : [playerName]
                                            }
                                            update(ref(db), updates);
                                        }
                                        else{
                                            const updates = {
                                                [`lobbies/${hash}/gameStatus/words/${i}/viewers`] : [...words[i].viewers, playerName]
                                            }
                                            update(ref(db), updates);
                                        }
                                        
                                    }

                                    if(!words[i].viewed){
                                        newDiv.appendChild(createUserHints(words[i].viewers, playerData));
                                    }
                                    cardsContainer.appendChild(newDiv);
                                }
                            }
                            else{
                                for(let i in words){
                                    const newDiv = createCard(words[i].name, words[i].color, visible, words[i].viewed);
                                    newDiv.appendChild(createUserHints(words[i].viewers, playerData));
                                    cardsContainer.appendChild(newDiv);
                                }
                            }
                        }
                        else{
                            //red spymaster turn
                            if(playerRole == 'red-spymaster'){
                                for(let i in words){
                                    cardsContainer.appendChild(createCard(words[i].name, words[i].color, visible, words[i].viewed))
                                }

                                const container = document.createElement('div');
                                container.className = 'input-container';
                                // container.style.width = '40%';

                                const input = document.createElement('input');
                                input.type = 'text';
                                input.className = 'form-control-lg';
                                input.id = 'clue-input';
                                input.maxLength = 20;

                                const numberInput = document.createElement('input');
                                numberInput.id = 'number-input-dog'
                                numberInput.type = 'number';
                                numberInput.className = 'form-control-lg number-input';
                                numberInput.max=10;
                                numberInput.min=1;

                                // Append the outer div to the body (or another container element)
                                const labelll = document.createElement('h4');
                                labelll.innerText = 'CLUE:'
                                labelll.style.color = 'white'
                                container.appendChild(labelll);
                                container.appendChild(input);

                                const numberContainer = document.createElement('div');
                                numberContainer.className = 'input-container';
                                numberContainer.style.width = '10em !important';

                                numberContainer.appendChild(numberInput);

                                const button = document.createElement('button');
                                button.type = 'button';
                                button.className = 'btn btn-success';
                                button.innerText = 'Confirm'
                                button.style.height = '100%'

                                button.onclick = function(){
                                    const num = document.getElementById('number-input-dog').value;
                                    const textinput = document.getElementById('clue-input').value;
                                    if(num && textinput){
                                        const action = {
                                            type:'clue',
                                            player:playerName,
                                            word: textinput,
                                            team: 'red',
                                            wordCount: num
                                        }
                                        const updates = {
                                            [`lobbies/${hash}/gameStatus/clue`]:textinput,
                                            [`lobbies/${hash}/gameStatus/clueCount`]: num,
                                            [`lobbies/${hash}/gameStatus/logs`]: 
                                            gameData.logs ? [...gameData.logs, action] : [action] 
                                        }
                                        update(ref(db), updates);
                                    }
                                    else{
                                        alert('Missing inputs');
                                    }
                                }

                                document.getElementById('player-options').appendChild(container);
                                document.getElementById('player-options').appendChild(numberContainer);
                                document.getElementById('player-options').appendChild(button);
                            }
                            else{
                                announcement.innerHTML = 'RED SPYMASTER is giving a clue'
                                for(let i in words){
                                    const newDiv = createCard(words[i].name, words[i].color, visible, words[i].viewed);
                                    // newDiv.appendChild(createUserHints(words[i].viewers, playerData));
                                    cardsContainer.appendChild(newDiv);
                                }
                            }
                        }
                    }
                    
                })
            }));
        </script>
    <body>
        <div id="announcement"></div>
        <div id="gamedisplay">
            <div id="red" class="red-ingame">
                <h1>Red Team</h1>
                <ul id="red-list" class="list-group"></ul>
                <h1 id="redCards"></h1>
                <h4>Players:</h4>
                <div id="redPlayers"></div>
                <h4>Spymaster:</h4>
                <span id="redspymaster" class="badge bg-danger"></span>
            </div>

            <div id="center" class="center"></div>
            <div id="blue-container-game">
                <div id="blue" class="blue-game blue-ingame">
                    <h1>Blue Team</h1>
                    <ul id="blue-list" class="list-group">
                    </ul>
                    <h1 id="blueCards"></h1>
                    <h4>Players:</h4>
                    <div id="bluePlayers"></div>
                    <h4>Spymaster:</h4>
                    <span id="bluespymaster" class="badge bg-primary"></span>
                </div>
                <div id="logs">
                </div>
            </div>
        </div>
        <div class="center-container">
            <div id="player-options"></div>
            
        </div>
        <div class="center-container">
            <div id="playerName"></div>
        </div>
    </body>
</html>